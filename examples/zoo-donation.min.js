//!name=动物园捐赠
//!player=10
//!include=poker-hand-evaluator.min.js
"use strict";const timeLimitPrepare=1999,timeLimitReplaceCard=60,timeLimitChooseCard=180,timeLimitBet=60,timeLimitCall=60,totalTurn=10,totalPlayer=10,allPlayerIds=[0,1,2,3,4,5,6,7,8,9],initCoin=100,dots=["2","3","4","5","6","7","8","9","T","J","Q","K","A"];let gameState={players:[],turn:0,cards:[],coins:[],goods:[],stage:0,showhand:!1,winner:-1,endStage:!1,showCards:[],backCards:[],currentBets:[],fold:[],history:[]},allCards=[],allCardsMap={};function initAll(){gameState.players=getPlayers();for(let t=0;t<totalPlayer;t++)gameState.coins.push(initCoin),gameState.goods.push(0),gameState.history.push("");for(let t of["鲜花","蜜桃","钻石","黑桃"])for(let e of dots)allCards.push(t+e);let t=0;for(let e of["C","H","D","S"])for(let a of dots)allCardsMap[allCards[t++]]=a+e}function checkGameEnd(){for(let t=0;t<totalPlayer;t++)if(gameState.goods[t]>=20)return!0;return gameState.turn>=totalTurn}function finalResult(){return"游戏结束，请等待裁判公布游戏结果。"}function shuffle(t){for(let e=0;e<5;e++){let e,a=t.length;for(;a>0;)e=Math.floor(Math.random()*a),a--,[t[a],t[e]]=[t[e],t[a]]}return t}function getShuffledCard(){let t=allCards.slice();return shuffle(t),t}function dirty(t){log(t);let e=new Set(t);if(5==e.size)return t;let a=0;for(let e=1;e<4;e++)for(let r=e+1;r<5;r++)if(t[e]==t[r]){a=e;break}let r=t[a];if(t[0][1]==t[1][1]&&t[0][1]==t[2][1]&&t[0][1]==t[3][1]&&t[0][1]==t[4][1]){let l=r;for(;(a=dots.indexOf(l[0]))>0;)if(l=dots[a-1]+l[1],!e.has(l))return t[a]=l,t;for(;;)if(a=dots.indexOf(l[0]),l=dots[a+1]+l[1],!e.has(l))return t[a]=l,t}return t[a]=t[a][0]+"C",e.has(t[a])?(t[a]=t[a][0]+"H",e.has(t[a])?(t[a]=t[a][0]+"D",e.has(t[a])?(t[a]=t[a][0]+"S",t):t):t):t}function bestRank(t){const e=gameState.cards[t].map(t=>allCardsMap[t]),a=gameState.showCards.map(t=>allCardsMap[t]),r=gameState.backCards.map(t=>allCardsMap[t]);let l=1e9;for(let t=0;t<3;t++)for(let n=t+1;n<4;n++)for(let s=n+1;s<5;s++){let o=dirty([e[0],e[1],a[t],a[n],a[s]]),g=new PokerHand(o.join(" ")).getScore(o);g<l&&(l=g),o=dirty([e[0],e[1],r[t],r[n],r[s]]),(g=new PokerHand(o.join(" ")).getScore(o))<l&&(l=g)}return l}let specialPlayerIds=shuffle(allPlayerIds.slice());function outputStatus(t){let e="";if(gameState.endStage){if(e="第"+gameState.turn+"轮结束。\n",e+="场上展示的牌是："+gameState.showCards.join(" ")+"\n",gameState.showhand){e+="未展示的五张牌是："+gameState.backCards.join(" ")+"\n\n",e+="玩家开牌情况：\n";for(let t=0;t<totalPlayer;t++)gameState.fold[t]||(e+=`${gameState.players[t].Name}：${gameState.cards[t].join(" ")}\n`)}else e+=`因其他玩家弃牌，${gameState.players[gameState.winner].Name}获得本轮胜利。`;e+="\n各玩家剩余点数情况：\n";for(let t=0;t<totalPlayer;t++)e+=`${gameState.players[t].Name}：${gameState.coins[t]}水晶，${gameState.goods[t]}好人卡；\n`;return gameState.history[t]+=e+"\n",gameState.history[t]}if(0==gameState.stage)e="当前第"+gameState.turn+"轮的开始阶段，你目前有"+gameState.coins[t]+"水晶，"+gameState.goods[t]+"好人卡。\n",e+="你目前的手牌是："+gameState.cards[t].join(" ")+"\n\n";else if(gameState.stage%2==1){if(e=`当前第 ${gameState.turn} 轮的第 ${(gameState.stage+1)/2} 阶段，你目前有`+gameState.coins[t]+"水晶，"+gameState.goods[t]+"好人卡。\n",e+="你目前的手牌是："+gameState.cards[t].join(" ")+"\n",e+="场上展示的牌是："+gameState.showCards.join(" ")+"\n\n",gameState.stage>1){e+="当前募捐情况：\n";for(let t=0;t<totalPlayer;t++)gameState.currentBets[t]>0&&(e+=gameState.players[t].Name+"募捐了"+gameState.currentBets[t]+"个水晶"+(0==gameState.coins[t]?"（全下）\n":gameState.fold[t]?"（已弃牌）\n":"。\n"))}}else if(gameState.stage%2==0){e=`当前第 ${gameState.turn} 轮的第 ${gameState.stage/2} 阶段，你目前有`+gameState.coins[t]+"水晶，"+gameState.goods[t]+"好人卡。\n",e+="你目前的手牌是："+gameState.cards[t].join(" ")+"\n",e+="场上展示的牌是："+gameState.showCards.join(" ")+"\n\n",e+="当前募捐情况：\n";for(let t=0;t<totalPlayer;t++)gameState.currentBets[t]>0&&(e+=gameState.players[t].Name+"募捐了"+gameState.currentBets[t]+"个水晶"+(0==gameState.coins[t]?"（全下）\n":gameState.fold[t]?"（已弃牌）\n":"。\n"))}return gameState.history[t]+e}function updateAll(){for(let t=0;t<totalPlayer;t++)updateStatus(t,outputStatus(t))}function main(){for(initAll(),getInputs("游戏即将开始，请输入【准备】","已准备",timeLimitPrepare,"准备",allPlayerIds,"input",mustEqualChecker("准备"));!checkGameEnd();){gameState.turn++;let t=getShuffledCard(),e=0;gameState.stage=0,gameState.showhand=!1,gameState.endStage=!1,gameState.cards=[],gameState.fold=[];for(let t=0;t<totalPlayer;t++)gameState.fold.push(0==gameState.coins[t]);let a=specialPlayerIds[gameState.turn-1];for(let r=0;r<totalPlayer;r++){if(gameState.fold[r]){gameState.cards.push([]);continue}let l=[];for(let a=0;a<3;a++)l.push(t[e++]);r==a&&(l[2]="【特殊牌】"),gameState.cards.push(l)}updateAll();let r=getInputs("请将【特殊牌】替换为任意一张牌，超时默认替换为"+gameState.cards[a][0],"替换成功",timeLimitChooseCard,gameState.cards[a][0],[a],"input",itemInListChecker(allCards));gameState.cards[a][2]=r[0],updateStatus(a,outputStatus(a));let l=[];for(let t=0;t<totalPlayer;t++)gameState.fold[t]||l.push(t);let n=getInputs("请选择一张手牌用于【物资储备】，超时默认第一张","选择成功",timeLimitChooseCard,"1",l,"input",numberInRangeChecker(1,3)),s=[];for(let t=0;t<totalPlayer;t++){if(gameState.fold[t])continue;let e=parseInt(n[t])-1;s.push(gameState.cards[t][e]),gameState.cards[t].splice(e,1)}shuffle(s),gameState.backCards=s.slice(5),gameState.showCards=[];for(let t=0;t<2;t++)gameState.showCards.push(s[t]);gameState.currentBets=[];for(let t=0;t<totalPlayer;t++)gameState.currentBets.push(0);let o=2;for(;gameState.stage<6;){gameState.stage++,gameState.showCards.push(s[o++]),updateAll();let t=[],e=[],a=[],r=1==gameState.stage?gameState.turn:0;for(let n of l)gameState.coins[n]>=r?(t.push(r),e.push("slider:"+r+":"+gameState.coins[n]),a.push(numberInRangeChecker(r,gameState.coins[n]))):(t.push(gameState.coins[n]),e.push("slider:"+gameState.coins[n]+":"+gameState.coins[n]),a.push(numberInRangeChecker(gameState.coins[n],gameState.coins[n])));n=getInputs("请选择募捐水晶数量，本轮最低募捐数量为"+r,"募捐成功",timeLimitBet,t,l,e,a),gameState.stage++;let g=0;for(let t=0;t<l.length;t++){let e=l[t],a=parseInt(n[t]);gameState.currentBets[e]+=a,gameState.coins[e]-=a,gameState.currentBets[e]>g&&(g=gameState.currentBets[e])}updateAll();let m=[];for(let t of l)gameState.currentBets[t]<g&&gameState.coins[t]>0&&m.push(t);n=getInputs("请选择是否跟投，超时默认放弃","选择成功",timeLimitCall,"放弃",m,"input",mustInChecker(["跟投","放弃"]));for(let t=0;t<m.length;t++){let e=m[t];if("跟投"==n[t]){let t=Math.min(gameState.coins[e],g-gameState.currentBets[e]);gameState.coins[e]-=t,gameState.currentBets[e]+=t}else gameState.fold[e]=!0}let i=0;for(let t=0;t<totalPlayer;t++)gameState.fold[t]||0==gameState.coins[t]||i++;if(i<=1)break}let g=0;gameState.winner=-1;for(let t=0;t<totalPlayer;t++)gameState.fold[t]||(g++,gameState.winner=t);let m=0;for(let t=0;t<totalPlayer;t++)m+=gameState.currentBets[t];if(1==g)gameState.coins[gameState.winner]+=m;else{gameState.showhand=!0,gameState.winner=-1;let t=1e9;for(let e=0;e<totalPlayer;e++){if(gameState.fold[e])continue;let a=bestRank(e);a<t&&(t=a,gameState.winner=e)}gameState.coins[gameState.winner]+=m}gameState.endStage=!0,updateAll()}let t=finalResult();return alertAll(t),appendStatusAll(t),0}